---
title: minecraft 开服指北
date: Wed Jan 05 2022 15:24:27 GMT+0800 (中国标准时间)
---

应群友强烈要求我又开始捣鼓 mc 的服务器，这次就不偷懒弄什么面板服了直接阿里云走起。

初步估计了一下会一起玩的朋友不超过 10 个，同时在线率不超过 50%。经过我反复试探 1.18.1 版本的 server 大约分配 1G 左右的内存即可流畅跑起来（如果太低可能会连基础服务都启动卡死）。我后续尝试将内存加到 2G 发现客户端无法顺畅的连接到服务器同时 ssh 也卡的飞起，基本可以判定提高了内存这块木板导致短板换成了 cpu，看了一波阿里云提供的方案似乎没有高 cpu & 高内存的游戏服务器专用云遂还是用 1G 内存，2 核 cpu 的机子吧。

# mod or plugin

可以确定的是 mod 模式更加古老，在稍早一段时间绝大部分的 mod 的 mc 的支持都停留在 1.7.+ 的版本，比如当时人气超高的和风 mod（虽然在近年来逐渐有大佬接坑，支持度逐渐上来了）。不过主要的原因是小伙伴们倾向于原版体验，所以这次的服务器被决定为插件服，而服务器核心无可争议的选择了 [paper](https://paper.readthedocs.io/en/latest/server/getting-started.html)。

paper 是 spigot 的一个分支，而 spigot 来自于 bukkit。所以几乎所有的 plugin 都支持 paper，而 paper 极佳的内部优化也让它从其他分支脱颖而出。

# 环境预处理

首先我们需要有个 OS，为了尽可能为 server 预留资源，我选择 CentOS。阿里云有个自己封装的 AliOS 我也适用了一下主打安全稳定，但全家桶装的太多反而不利于我们用所以直接放弃。

## java

1.18+ 版本的 paper 核心要求 java17 的环境

![图片](/images/2c9a9140d7fd452b5b4c091ac9ddd426ed07a2b60a8599e0d46522b94961704a.png)

### 卸载系统自带 jdk

纯净的 CentOS 并没有自带 java，不过不妨碍我们先检查一下

```
rpm -qa|grep java
```

### 查找 java 列表

```
yum -y list java*
```

万军丛中找到我们所需要的 jdk，由于我装过 jdk 所以不会在列表里显示，所以下图是用 `yum search jdk` 查询得到的，两者等效

![图片](/images/6cec485fb23e377b304981c772a6c48d04e01ea4d1f5087680658d514c8e64a5.png)

### 安装 java

```
yum install -y java-17-openjdk.x86_64
// 验证是否安装成功
java -version
```

# 交换内存

在 window 中我们也称为虚拟内存，如今动辄 16G、23G 内存的家庭机确实用不上这个技术，不过在内存稀缺的过去当内存空间出现不足时 OS 会尝试把部分不活跃内存存储到硬盘上，硬盘的存读速度非常慢但好过内存溢出强制 kill 进程，给用户缓冲的余地。

## 检查 swap 信息

在“寸土寸金”的服务器上，很明显我们需要它。我们能做的是在内存溢出的边缘最大化的利用服务器资源，但难免遇到意外之事，比如访问量激增，游戏自动备份等。为了防止出现这种情况直接打挂服务器我们需要设置一定的交换内存。

```
swapon -s
```

在纯净的 OS 上使用 swapon 查询可能得不到任何信息，因为虚拟内存并没有被设置，我们可以通过检查内存来查看

```
free -m
```

可以看到在 Swap 一栏都为 0

![图片](/images/2348e791953dc34a7866334203692f253250943dd502ae2fe468d94dbc9f6df3.png)

## 检查磁盘信息

按照上面说的原理，我们需要在磁盘上化一块区域用来供给内存用，所以我们可以先检查一下磁盘

```
df -h
```

我们主要的存储分区有 60G 的空间，我们可以大方的划出 4 个 G 来做交换空间

![图片](/images/45ca4bc8cba9c4a57751a9b691aae99fe3f7bc89d8dd611870d3d5cedb174927.png)

## 创建交换内存

第一步我们可以在分区根目录创建一个文件 swapfile ，当然可以是其他位置或者其他名称

```
fallocate -l 4G /swapfile
// 需要给此文件管理员可读权限，同时不允许其他用户读取（否则就相当于非法访问内存了）
chmod 600 /swapfile
```

第二步为我们创建的文件写入标准的格式头，这一步的作用是声明该文件会被用于存储内存信息，否则无法识别

```
mkswap /swapfile
```

最后我们将其制定为交换内存

```
swapon /swapfile
```

走到这一步我们的交换内存已经生效了，不过系统重启还是会失效，所以我们可以在 `/etc/fstab` 增加一行永久让他生效

```
# /etc/fstab
/swapfile    swap    swap    sw  0   0
```
